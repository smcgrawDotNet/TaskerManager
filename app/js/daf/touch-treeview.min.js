/*!
* Touch UI - Tree View
* Copyright 2023 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function h(n,t){var r,i;for(r in n)i=n[r],t&&(i.parent=t),i.nodes&&h(i.nodes,i)}function r(n){var i=t.treeView._navigating;return arguments.length&&i!=n&&(t.treeView._navigating=n,t.activePage(".app-treeview").css("visibility",n?"hidden":"")),i}function f(i,u){var s,o,c,e,l,w,h,a,v,y,p;if(typeof u=="string"){if(s=u.match(/^(.+?)\:\/\/(.+)$/),s)if(o=t.treeView.context(i),o.hierarchy.endsWith("."+s[1]))u=s[2];else{if(r(!1),o.eventName="navigate",o.path=u,c=$.Event("treeview.app",{treeView:o}),$(document).trigger(c),c.isDefaultPrevented())return;t.notify({text:`Unable to navigate to ${u}`,duration:"long"})}if(u.match(/^\./)){r(!1);t.propGrid.select(u.substring(1));return}u=u.split(/\//g);u.forEach((n,t)=>{n.match(/^\./)||(n=n.toLowerCase()),u[t]=decodeURIComponent(n)})}u.length&&(i.find(">li").each(function(){var n=$(this),t=n.data("nodeId");if(t===u[0])return e=n,!1}),e?(u._cleared||(e.closest(".app-treeview").find(".app-selected").removeClass("app-selected"),u._cleared=!0),u.splice(0,1),l=!0,u.length===1&&u[0].match(/^\./)?(w=t.dataView(),n.userVar(`${w._survey.context.instance}.navigate`,u[0])):u.length&&(l=!1,e.is(".app-collapsed")&&e.find(">.app-node>.app-toggle").trigger("vclick"),f(e.find("ul"),u)),l&&(h=e.data("navigating",!0).find(">.app-node").trigger("vclick"),e.removeData("navigating"),a=h.find(".app-anchor")[0],t.busy()||r()?a.scrollIntoView({block:"center",behavior:"instant"}):(v=n.clientRect(h.closest(".app-treeview")),y=n.clientRect(h),y.top>v.top&&y.bottom<v.bottom||t.pageShown(()=>{setTimeout(()=>{a.scrollIntoView({block:"center",behavior:"smooth"})})})),r(!1))):(p=i.find(">.app-loading"),p.length?p.data("navigate",u):r(!1)))}function e(t,i,r){var o,v,y;for(o in i){var f=i[o],a=n.eval(f.text,r)||n.prettyText(o,!0),w=f.id?n.eval(f.id,r):a;(f.text==null||f.text===a)&&(w=o);var b=f.type,l=p().attr({"data-type":b}).appendTo(t).data({nodeName:o,nodeTemplate:f,nodeData:r,nodeId:encodeURIComponent(w.toLowerCase())}),h=u("app-node").appendTo(l),k=u("app-anchor").appendTo(h),d=u("app-text").appendTo(h).text(a);f.textMuted&&(v=n.eval(f.textMuted,r),v!=null&&u("app-muted").appendTo(h).text(v));f.icon&&h.addClass(n.eval(f.icon,r));f.iterate&&r==null?(h.text("Loading..."),l.addClass("app-loading"),y=t.closest("li"),(!y.length||y.is(".app-expanded"))&&c(o,f,t,l)):f.nodes&&(l.addClass(f.expanded?"app-expanded":"app-collapsed"),u("app-toggle").appendTo(h),e(s().appendTo(l),f.nodes))}}function c(n,t,i,r){var o=l("iterate",r),u=o.treeView.result;u instanceof Promise||(Array.isArray(u)||(u=[u]),u=Promise.resolve(u));u.then(u=>{var s={},o;s[n]=t;u.forEach(n=>{e(i,s,n)});o=r.data("navigate");r.remove();u.length||i.closest("li").removeClass("app-expanded").find(".app-node .app-toggle").remove();o?f(i,o):a(i.parent())})}function l(i,r){var u=t.treeView.context(r),f;return u.eventName=i,i==="select"&&n.userVar("treeview."+u.hierarchy,u.nodePath),f=$.Event("treeview.app",{treeView:u}),$(document).trigger(f),f}function a(t){var u,i;if(!r()){var o=n.clientRect(t),s=t.closest(".app-treeview"),f=n.clientRect(s),e=t.find("> ul"),h=n.clientRect(e);h.bottom>f.bottom&&(u="start",i=t,o.height<f.height&&(i=e,u="end"),i.length&&i[0].scrollIntoView({block:u,behavior:"smooth"}))}}var n=$app,o=n.input,t=n.touch,w=$(document),v=Web.DataViewResources,b=v.Data.BooleanDefaultItems,k=n.clientRect,i=n.html,d=i.tag,g=i.div,nt=i.span,tt=i.$tag,it=i.$p,y=i.$div,u=i.$span,rt=i.$a,ut=i.$i,p=i.$li,s=i.$ul;t.treeView=function(i,u){var o,c,l;typeof i!="string"&&(u=i,i="show");o=u.nodes;o instanceof Promise?o.then(n=>{u.nodes=n.nodes||{},t.treeView(i,u)}):(h(o),c=u.treeView,c?(o=u.nodes||c.data("nodes"),e(s().appendTo(c.empty()),o,null)):(c=y("app-treeview app-has-scrollbars").attr({"data-hierarchy":u.type,tabindex:-1}).data({nodes:o}),e(s().appendTo(c),o,null),c.appendTo(u.container)),l=n.userVar("treeview."+u.type),l&&(r(!0),f(c.find("ul"),l)))};$(document).on("vclick",".app-toggle",n=>{var t,i;if(o.valid())return t=$(n.target).closest("li"),t.is(".app-expanded")?t.removeClass("app-expanded").addClass("app-collapsed"):(t.removeClass("app-collapsed").addClass("app-expanded"),i=!0,t.find("> ul > li.app-loading").each(function(){var n=$(this),t=n.data();c(t.nodeName,t.nodeTemplate,n.parent(),n);i=!1}),i&&a(t)),!1}).on("vclick",".app-treeview li span",i=>{var f=$(i.target),a,u,s,e,h,c;if(o.valid())return(u=f.closest("li"),u.is(".app-loading"))?!1:!f.is(".app-toggle")&&t.dblClick($(f))?(u.find("> .app-node .app-toggle").trigger("vclick"),!1):i.isDefaultPrevented()||u.is(".app-selected")?!1:(a=f.closest(".app-treeview"),u=f.closest("li"),a.find(".app-selected").removeClass("app-selected"),u.addClass("app-selected"),s=f.closest(".app-node"),e=null,r()||u.data("navigating")||(h=n.clientRect(s),c=n.clientRect(u.closest(".app-treeview")),h.bottom>c.bottom?e="end":h.top<c.top&&(e="start")),e&&s[0].scrollIntoView({block:e,behavior:"smooth"}),setTimeout(l,e?96:0,"select",u),!1)}).on("vclick","[data-studio-link]",n=>{var t,i,u;if(o.valid())return t=$(n.target),i=t.closest("[data-studio-link]").attr("data-studio-link"),i&&(u=t.closest(".app-propgrid").find("[data-hierarchy]"),r(!0),f(u.find(">ul"),i)),!1});t.treeView.data=function(n){var i;return n?Array.isArray(n)||(n=n.split(/\s*,\s*/g)):i={},t.activePage(".app-treeview .app-selected:first .app-node").parents("li").each(function(){var r=$(this),t=r.attr("data-type"),u=r.data("nodeData");if(n){if(n.forEach(n=>{n===t&&(i=u)}),i)return!1}else t&&(i[t]=u||{})}),i};t.treeView.context=function(n){n||(n=t.activePage(".app-treeview .app-selected:first"));for(var u=n.length?n.closest(".app-treeview"):t.activePage(".app-treeview"),e=u.attr("data-hierarchy"),o=n.data("nodeTemplate"),r,i=n,f=[];i.length;)f.splice(0,0,i.is(".app-loading")?"*":i.data("nodeId")),r==null&&(r=i.data("nodeData")),i=i.parent().closest("li");return{hierarchy:e,treeView:u,node:o,nodePath:f.join("/"),nodeData:r,nodeElem:n}}})()